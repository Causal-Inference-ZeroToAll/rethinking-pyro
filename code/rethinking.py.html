<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="rethinking.py">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>rethinking.py | Statistical Rethinking with PyTorch and Pyro</title>
<link href="../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.xml">
<link rel="canonical" href="https://fehiepsi.github.io/rethinking-pyro/code/rethinking.py.html">
<!--[if lt IE 9]><script src="../assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="https://fehiepsi.github.io/rethinking-pyro/">

            <span id="blog-title">Statistical Rethinking with PyTorch and Pyro</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav"></ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100"></ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        

<nav class="breadcrumbs"><ul class="breadcrumb">
<li class="breadcrumb-item"><a href=".">code</a></li>
                <li class="breadcrumb-item active">rethinking.py</li>
</ul></nav><h1>rethinking.py
        <small><a href="rethinking.py">(Source)</a></small>
    </h1>
    <table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="#listingsrethinkingpy-1">  1</a>
<a href="#listingsrethinkingpy-2">  2</a>
<a href="#listingsrethinkingpy-3">  3</a>
<a href="#listingsrethinkingpy-4">  4</a>
<a href="#listingsrethinkingpy-5">  5</a>
<a href="#listingsrethinkingpy-6">  6</a>
<a href="#listingsrethinkingpy-7">  7</a>
<a href="#listingsrethinkingpy-8">  8</a>
<a href="#listingsrethinkingpy-9">  9</a>
<a href="#listingsrethinkingpy-10"> 10</a>
<a href="#listingsrethinkingpy-11"> 11</a>
<a href="#listingsrethinkingpy-12"> 12</a>
<a href="#listingsrethinkingpy-13"> 13</a>
<a href="#listingsrethinkingpy-14"> 14</a>
<a href="#listingsrethinkingpy-15"> 15</a>
<a href="#listingsrethinkingpy-16"> 16</a>
<a href="#listingsrethinkingpy-17"> 17</a>
<a href="#listingsrethinkingpy-18"> 18</a>
<a href="#listingsrethinkingpy-19"> 19</a>
<a href="#listingsrethinkingpy-20"> 20</a>
<a href="#listingsrethinkingpy-21"> 21</a>
<a href="#listingsrethinkingpy-22"> 22</a>
<a href="#listingsrethinkingpy-23"> 23</a>
<a href="#listingsrethinkingpy-24"> 24</a>
<a href="#listingsrethinkingpy-25"> 25</a>
<a href="#listingsrethinkingpy-26"> 26</a>
<a href="#listingsrethinkingpy-27"> 27</a>
<a href="#listingsrethinkingpy-28"> 28</a>
<a href="#listingsrethinkingpy-29"> 29</a>
<a href="#listingsrethinkingpy-30"> 30</a>
<a href="#listingsrethinkingpy-31"> 31</a>
<a href="#listingsrethinkingpy-32"> 32</a>
<a href="#listingsrethinkingpy-33"> 33</a>
<a href="#listingsrethinkingpy-34"> 34</a>
<a href="#listingsrethinkingpy-35"> 35</a>
<a href="#listingsrethinkingpy-36"> 36</a>
<a href="#listingsrethinkingpy-37"> 37</a>
<a href="#listingsrethinkingpy-38"> 38</a>
<a href="#listingsrethinkingpy-39"> 39</a>
<a href="#listingsrethinkingpy-40"> 40</a>
<a href="#listingsrethinkingpy-41"> 41</a>
<a href="#listingsrethinkingpy-42"> 42</a>
<a href="#listingsrethinkingpy-43"> 43</a>
<a href="#listingsrethinkingpy-44"> 44</a>
<a href="#listingsrethinkingpy-45"> 45</a>
<a href="#listingsrethinkingpy-46"> 46</a>
<a href="#listingsrethinkingpy-47"> 47</a>
<a href="#listingsrethinkingpy-48"> 48</a>
<a href="#listingsrethinkingpy-49"> 49</a>
<a href="#listingsrethinkingpy-50"> 50</a>
<a href="#listingsrethinkingpy-51"> 51</a>
<a href="#listingsrethinkingpy-52"> 52</a>
<a href="#listingsrethinkingpy-53"> 53</a>
<a href="#listingsrethinkingpy-54"> 54</a>
<a href="#listingsrethinkingpy-55"> 55</a>
<a href="#listingsrethinkingpy-56"> 56</a>
<a href="#listingsrethinkingpy-57"> 57</a>
<a href="#listingsrethinkingpy-58"> 58</a>
<a href="#listingsrethinkingpy-59"> 59</a>
<a href="#listingsrethinkingpy-60"> 60</a>
<a href="#listingsrethinkingpy-61"> 61</a>
<a href="#listingsrethinkingpy-62"> 62</a>
<a href="#listingsrethinkingpy-63"> 63</a>
<a href="#listingsrethinkingpy-64"> 64</a>
<a href="#listingsrethinkingpy-65"> 65</a>
<a href="#listingsrethinkingpy-66"> 66</a>
<a href="#listingsrethinkingpy-67"> 67</a>
<a href="#listingsrethinkingpy-68"> 68</a>
<a href="#listingsrethinkingpy-69"> 69</a>
<a href="#listingsrethinkingpy-70"> 70</a>
<a href="#listingsrethinkingpy-71"> 71</a>
<a href="#listingsrethinkingpy-72"> 72</a>
<a href="#listingsrethinkingpy-73"> 73</a>
<a href="#listingsrethinkingpy-74"> 74</a>
<a href="#listingsrethinkingpy-75"> 75</a>
<a href="#listingsrethinkingpy-76"> 76</a>
<a href="#listingsrethinkingpy-77"> 77</a>
<a href="#listingsrethinkingpy-78"> 78</a>
<a href="#listingsrethinkingpy-79"> 79</a>
<a href="#listingsrethinkingpy-80"> 80</a>
<a href="#listingsrethinkingpy-81"> 81</a>
<a href="#listingsrethinkingpy-82"> 82</a>
<a href="#listingsrethinkingpy-83"> 83</a>
<a href="#listingsrethinkingpy-84"> 84</a>
<a href="#listingsrethinkingpy-85"> 85</a>
<a href="#listingsrethinkingpy-86"> 86</a>
<a href="#listingsrethinkingpy-87"> 87</a>
<a href="#listingsrethinkingpy-88"> 88</a>
<a href="#listingsrethinkingpy-89"> 89</a>
<a href="#listingsrethinkingpy-90"> 90</a>
<a href="#listingsrethinkingpy-91"> 91</a>
<a href="#listingsrethinkingpy-92"> 92</a>
<a href="#listingsrethinkingpy-93"> 93</a>
<a href="#listingsrethinkingpy-94"> 94</a>
<a href="#listingsrethinkingpy-95"> 95</a>
<a href="#listingsrethinkingpy-96"> 96</a>
<a href="#listingsrethinkingpy-97"> 97</a>
<a href="#listingsrethinkingpy-98"> 98</a>
<a href="#listingsrethinkingpy-99"> 99</a>
<a href="#listingsrethinkingpy-100">100</a>
<a href="#listingsrethinkingpy-101">101</a>
<a href="#listingsrethinkingpy-102">102</a>
<a href="#listingsrethinkingpy-103">103</a>
<a href="#listingsrethinkingpy-104">104</a>
<a href="#listingsrethinkingpy-105">105</a>
<a href="#listingsrethinkingpy-106">106</a>
<a href="#listingsrethinkingpy-107">107</a>
<a href="#listingsrethinkingpy-108">108</a>
<a href="#listingsrethinkingpy-109">109</a>
<a href="#listingsrethinkingpy-110">110</a>
<a href="#listingsrethinkingpy-111">111</a>
<a href="#listingsrethinkingpy-112">112</a>
<a href="#listingsrethinkingpy-113">113</a>
<a href="#listingsrethinkingpy-114">114</a>
<a href="#listingsrethinkingpy-115">115</a>
<a href="#listingsrethinkingpy-116">116</a>
<a href="#listingsrethinkingpy-117">117</a>
<a href="#listingsrethinkingpy-118">118</a>
<a href="#listingsrethinkingpy-119">119</a>
<a href="#listingsrethinkingpy-120">120</a>
<a href="#listingsrethinkingpy-121">121</a>
<a href="#listingsrethinkingpy-122">122</a>
<a href="#listingsrethinkingpy-123">123</a>
<a href="#listingsrethinkingpy-124">124</a>
<a href="#listingsrethinkingpy-125">125</a>
<a href="#listingsrethinkingpy-126">126</a>
<a href="#listingsrethinkingpy-127">127</a>
<a href="#listingsrethinkingpy-128">128</a>
<a href="#listingsrethinkingpy-129">129</a>
<a href="#listingsrethinkingpy-130">130</a>
<a href="#listingsrethinkingpy-131">131</a>
<a href="#listingsrethinkingpy-132">132</a>
<a href="#listingsrethinkingpy-133">133</a>
<a href="#listingsrethinkingpy-134">134</a>
<a href="#listingsrethinkingpy-135">135</a>
<a href="#listingsrethinkingpy-136">136</a>
<a href="#listingsrethinkingpy-137">137</a>
<a href="#listingsrethinkingpy-138">138</a>
<a href="#listingsrethinkingpy-139">139</a>
<a href="#listingsrethinkingpy-140">140</a>
<a href="#listingsrethinkingpy-141">141</a>
<a href="#listingsrethinkingpy-142">142</a>
<a href="#listingsrethinkingpy-143">143</a>
<a href="#listingsrethinkingpy-144">144</a>
<a href="#listingsrethinkingpy-145">145</a>
<a href="#listingsrethinkingpy-146">146</a>
<a href="#listingsrethinkingpy-147">147</a>
<a href="#listingsrethinkingpy-148">148</a>
<a href="#listingsrethinkingpy-149">149</a>
<a href="#listingsrethinkingpy-150">150</a>
<a href="#listingsrethinkingpy-151">151</a>
<a href="#listingsrethinkingpy-152">152</a>
<a href="#listingsrethinkingpy-153">153</a>
<a href="#listingsrethinkingpy-154">154</a>
<a href="#listingsrethinkingpy-155">155</a>
<a href="#listingsrethinkingpy-156">156</a>
<a href="#listingsrethinkingpy-157">157</a>
<a href="#listingsrethinkingpy-158">158</a>
<a href="#listingsrethinkingpy-159">159</a>
<a href="#listingsrethinkingpy-160">160</a>
<a href="#listingsrethinkingpy-161">161</a>
<a href="#listingsrethinkingpy-162">162</a>
<a href="#listingsrethinkingpy-163">163</a>
<a href="#listingsrethinkingpy-164">164</a>
<a href="#listingsrethinkingpy-165">165</a>
<a href="#listingsrethinkingpy-166">166</a>
<a href="#listingsrethinkingpy-167">167</a>
<a href="#listingsrethinkingpy-168">168</a>
<a href="#listingsrethinkingpy-169">169</a>
<a href="#listingsrethinkingpy-170">170</a>
<a href="#listingsrethinkingpy-171">171</a>
<a href="#listingsrethinkingpy-172">172</a>
<a href="#listingsrethinkingpy-173">173</a>
<a href="#listingsrethinkingpy-174">174</a>
<a href="#listingsrethinkingpy-175">175</a>
<a href="#listingsrethinkingpy-176">176</a>
<a href="#listingsrethinkingpy-177">177</a>
<a href="#listingsrethinkingpy-178">178</a>
<a href="#listingsrethinkingpy-179">179</a>
<a href="#listingsrethinkingpy-180">180</a>
<a href="#listingsrethinkingpy-181">181</a>
<a href="#listingsrethinkingpy-182">182</a>
<a href="#listingsrethinkingpy-183">183</a>
<a href="#listingsrethinkingpy-184">184</a>
<a href="#listingsrethinkingpy-185">185</a>
<a href="#listingsrethinkingpy-186">186</a>
<a href="#listingsrethinkingpy-187">187</a>
<a href="#listingsrethinkingpy-188">188</a>
<a href="#listingsrethinkingpy-189">189</a>
<a href="#listingsrethinkingpy-190">190</a>
<a href="#listingsrethinkingpy-191">191</a>
<a href="#listingsrethinkingpy-192">192</a>
<a href="#listingsrethinkingpy-193">193</a>
<a href="#listingsrethinkingpy-194">194</a>
<a href="#listingsrethinkingpy-195">195</a>
<a href="#listingsrethinkingpy-196">196</a>
<a href="#listingsrethinkingpy-197">197</a>
<a href="#listingsrethinkingpy-198">198</a>
<a href="#listingsrethinkingpy-199">199</a>
<a href="#listingsrethinkingpy-200">200</a>
<a href="#listingsrethinkingpy-201">201</a>
<a href="#listingsrethinkingpy-202">202</a>
<a href="#listingsrethinkingpy-203">203</a>
<a href="#listingsrethinkingpy-204">204</a>
<a href="#listingsrethinkingpy-205">205</a>
<a href="#listingsrethinkingpy-206">206</a>
<a href="#listingsrethinkingpy-207">207</a>
<a href="#listingsrethinkingpy-208">208</a>
<a href="#listingsrethinkingpy-209">209</a>
<a href="#listingsrethinkingpy-210">210</a>
<a href="#listingsrethinkingpy-211">211</a>
<a href="#listingsrethinkingpy-212">212</a>
<a href="#listingsrethinkingpy-213">213</a>
<a href="#listingsrethinkingpy-214">214</a>
<a href="#listingsrethinkingpy-215">215</a>
<a href="#listingsrethinkingpy-216">216</a>
<a href="#listingsrethinkingpy-217">217</a>
<a href="#listingsrethinkingpy-218">218</a>
<a href="#listingsrethinkingpy-219">219</a>
<a href="#listingsrethinkingpy-220">220</a>
<a href="#listingsrethinkingpy-221">221</a>
<a href="#listingsrethinkingpy-222">222</a>
<a href="#listingsrethinkingpy-223">223</a>
<a href="#listingsrethinkingpy-224">224</a>
<a href="#listingsrethinkingpy-225">225</a>
<a href="#listingsrethinkingpy-226">226</a>
<a href="#listingsrethinkingpy-227">227</a>
<a href="#listingsrethinkingpy-228">228</a>
<a href="#listingsrethinkingpy-229">229</a>
<a href="#listingsrethinkingpy-230">230</a>
<a href="#listingsrethinkingpy-231">231</a>
<a href="#listingsrethinkingpy-232">232</a>
<a href="#listingsrethinkingpy-233">233</a>
<a href="#listingsrethinkingpy-234">234</a>
<a href="#listingsrethinkingpy-235">235</a>
<a href="#listingsrethinkingpy-236">236</a>
<a href="#listingsrethinkingpy-237">237</a>
<a href="#listingsrethinkingpy-238">238</a>
<a href="#listingsrethinkingpy-239">239</a>
<a href="#listingsrethinkingpy-240">240</a>
<a href="#listingsrethinkingpy-241">241</a>
<a href="#listingsrethinkingpy-242">242</a>
<a href="#listingsrethinkingpy-243">243</a>
<a href="#listingsrethinkingpy-244">244</a>
<a href="#listingsrethinkingpy-245">245</a>
<a href="#listingsrethinkingpy-246">246</a>
<a href="#listingsrethinkingpy-247">247</a>
<a href="#listingsrethinkingpy-248">248</a>
<a href="#listingsrethinkingpy-249">249</a>
<a href="#listingsrethinkingpy-250">250</a>
<a href="#listingsrethinkingpy-251">251</a>
<a href="#listingsrethinkingpy-252">252</a>
<a href="#listingsrethinkingpy-253">253</a>
<a href="#listingsrethinkingpy-254">254</a>
<a href="#listingsrethinkingpy-255">255</a>
<a href="#listingsrethinkingpy-256">256</a>
<a href="#listingsrethinkingpy-257">257</a>
<a href="#listingsrethinkingpy-258">258</a>
<a href="#listingsrethinkingpy-259">259</a>
<a href="#listingsrethinkingpy-260">260</a>
<a href="#listingsrethinkingpy-261">261</a>
<a href="#listingsrethinkingpy-262">262</a>
<a href="#listingsrethinkingpy-263">263</a>
<a href="#listingsrethinkingpy-264">264</a>
<a href="#listingsrethinkingpy-265">265</a>
<a href="#listingsrethinkingpy-266">266</a>
<a href="#listingsrethinkingpy-267">267</a>
<a href="#listingsrethinkingpy-268">268</a>
<a href="#listingsrethinkingpy-269">269</a>
<a href="#listingsrethinkingpy-270">270</a>
<a href="#listingsrethinkingpy-271">271</a>
<a href="#listingsrethinkingpy-272">272</a>
<a href="#listingsrethinkingpy-273">273</a>
<a href="#listingsrethinkingpy-274">274</a>
<a href="#listingsrethinkingpy-275">275</a>
<a href="#listingsrethinkingpy-276">276</a>
<a href="#listingsrethinkingpy-277">277</a>
<a href="#listingsrethinkingpy-278">278</a>
<a href="#listingsrethinkingpy-279">279</a>
<a href="#listingsrethinkingpy-280">280</a>
<a href="#listingsrethinkingpy-281">281</a>
<a href="#listingsrethinkingpy-282">282</a>
<a href="#listingsrethinkingpy-283">283</a>
<a href="#listingsrethinkingpy-284">284</a>
<a href="#listingsrethinkingpy-285">285</a></pre></div></td>
<td class="code"><pre class="code literal-block"><a name="listingsrethinkingpy-1"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<a name="listingsrethinkingpy-2"></a><span class="kn">import</span> <span class="nn">torch</span>
<a name="listingsrethinkingpy-3"></a><span class="kn">from</span> <span class="nn">torch.distributions</span> <span class="kn">import</span> <span class="n">transform_to</span><span class="p">,</span> <span class="n">constraints</span>
<a name="listingsrethinkingpy-4"></a>
<a name="listingsrethinkingpy-5"></a><span class="kn">import</span> <span class="nn">pyro</span>
<a name="listingsrethinkingpy-6"></a><span class="kn">import</span> <span class="nn">pyro.distributions</span> <span class="kn">as</span> <span class="nn">dist</span>
<a name="listingsrethinkingpy-7"></a><span class="kn">import</span> <span class="nn">pyro.ops.stats</span> <span class="kn">as</span> <span class="nn">stats</span>
<a name="listingsrethinkingpy-8"></a><span class="kn">import</span> <span class="nn">pyro.poutine</span> <span class="kn">as</span> <span class="nn">poutine</span>
<a name="listingsrethinkingpy-9"></a><span class="kn">from</span> <span class="nn">pyro.contrib.autoguide</span> <span class="kn">import</span> <span class="n">AutoLaplaceApproximation</span>
<a name="listingsrethinkingpy-10"></a><span class="kn">from</span> <span class="nn">pyro.infer</span> <span class="kn">import</span> <span class="n">TracePosterior</span><span class="p">,</span> <span class="n">TracePredictive</span><span class="p">,</span> <span class="n">Trace_ELBO</span>
<a name="listingsrethinkingpy-11"></a><span class="kn">from</span> <span class="nn">pyro.ops.welford</span> <span class="kn">import</span> <span class="n">WelfordCovariance</span>
<a name="listingsrethinkingpy-12"></a>
<a name="listingsrethinkingpy-13"></a>
<a name="listingsrethinkingpy-14"></a><span class="k">class</span> <span class="nc">MAP</span><span class="p">(</span><span class="n">TracePosterior</span><span class="p">):</span>
<a name="listingsrethinkingpy-15"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="p">{}):</span>
<a name="listingsrethinkingpy-16"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">MAP</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a name="listingsrethinkingpy-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
<a name="listingsrethinkingpy-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="n">num_samples</span>
<a name="listingsrethinkingpy-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
<a name="listingsrethinkingpy-20"></a>
<a name="listingsrethinkingpy-21"></a>    <span class="k">def</span> <span class="nf">_traces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a name="listingsrethinkingpy-22"></a>        <span class="c1"># find good initial trace</span>
<a name="listingsrethinkingpy-23"></a>        <span class="n">model_trace</span> <span class="o">=</span> <span class="n">poutine</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a name="listingsrethinkingpy-24"></a>        <span class="n">best_log_prob</span> <span class="o">=</span> <span class="n">model_trace</span><span class="o">.</span><span class="n">log_prob_sum</span><span class="p">()</span>
<a name="listingsrethinkingpy-25"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
<a name="listingsrethinkingpy-26"></a>            <span class="n">trace</span> <span class="o">=</span> <span class="n">poutine</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a name="listingsrethinkingpy-27"></a>            <span class="n">log_prob</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">log_prob_sum</span><span class="p">()</span>
<a name="listingsrethinkingpy-28"></a>            <span class="k">if</span> <span class="n">log_prob</span> <span class="o">&gt;</span> <span class="n">best_log_prob</span><span class="p">:</span>
<a name="listingsrethinkingpy-29"></a>                <span class="n">best_log_prob</span> <span class="o">=</span> <span class="n">log_prob</span>
<a name="listingsrethinkingpy-30"></a>                <span class="n">model_trace</span> <span class="o">=</span> <span class="n">trace</span>
<a name="listingsrethinkingpy-31"></a>
<a name="listingsrethinkingpy-32"></a>        <span class="c1"># lift model</span>
<a name="listingsrethinkingpy-33"></a>        <span class="n">prior</span><span class="p">,</span> <span class="n">unpacked</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
<a name="listingsrethinkingpy-34"></a>        <span class="n">param_constraints</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">get_param_store</span><span class="p">()</span><span class="o">.</span><span class="n">get_state</span><span class="p">()[</span><span class="s2">"constraints"</span><span class="p">]</span>
<a name="listingsrethinkingpy-35"></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">model_trace</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a name="listingsrethinkingpy-36"></a>            <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"param"</span><span class="p">:</span>
<a name="listingsrethinkingpy-37"></a>                <span class="k">if</span> <span class="n">param_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="ow">is</span> <span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">:</span>
<a name="listingsrethinkingpy-38"></a>                    <span class="n">prior</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">HalfCauchy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="listingsrethinkingpy-39"></a>                <span class="k">else</span><span class="p">:</span>
<a name="listingsrethinkingpy-40"></a>                    <span class="n">prior</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a name="listingsrethinkingpy-41"></a>                <span class="n">unpacked</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">unconstrained</span><span class="p">()</span>
<a name="listingsrethinkingpy-42"></a>            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
<a name="listingsrethinkingpy-43"></a>                <span class="n">unpacked</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<a name="listingsrethinkingpy-44"></a>            <span class="k">elif</span> <span class="n">node</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"sample"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="p">[</span><span class="s2">"is_observed"</span><span class="p">]:</span>
<a name="listingsrethinkingpy-45"></a>                <span class="n">unpacked</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform_to</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s2">"fn"</span><span class="p">]</span><span class="o">.</span><span class="n">support</span><span class="p">)</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s2">"value"</span><span class="p">])</span>
<a name="listingsrethinkingpy-46"></a>        <span class="n">lifted_model</span> <span class="o">=</span> <span class="n">poutine</span><span class="o">.</span><span class="n">lift</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">prior</span><span class="p">)</span>
<a name="listingsrethinkingpy-47"></a>
<a name="listingsrethinkingpy-48"></a>        <span class="c1"># define guide</span>
<a name="listingsrethinkingpy-49"></a>        <span class="n">packed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">unpacked</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
<a name="listingsrethinkingpy-50"></a>        <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">"auto_loc"</span><span class="p">,</span> <span class="n">packed</span><span class="p">)</span>
<a name="listingsrethinkingpy-51"></a>        <span class="n">delta_guide</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">lifted_model</span><span class="p">)</span>
<a name="listingsrethinkingpy-52"></a>
<a name="listingsrethinkingpy-53"></a>        <span class="c1"># train guide</span>
<a name="listingsrethinkingpy-54"></a>        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">LBFGS</span><span class="p">((</span><span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">"auto_loc"</span><span class="p">)</span><span class="o">.</span><span class="n">unconstrained</span><span class="p">(),),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<a name="listingsrethinkingpy-55"></a>        <span class="n">loss_and_grads</span> <span class="o">=</span> <span class="n">Trace_ELBO</span><span class="p">()</span><span class="o">.</span><span class="n">loss_and_grads</span>
<a name="listingsrethinkingpy-56"></a>
<a name="listingsrethinkingpy-57"></a>        <span class="k">def</span> <span class="nf">closure</span><span class="p">():</span>
<a name="listingsrethinkingpy-58"></a>            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a name="listingsrethinkingpy-59"></a>            <span class="k">return</span> <span class="n">loss_and_grads</span><span class="p">(</span><span class="n">lifted_model</span><span class="p">,</span> <span class="n">delta_guide</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a name="listingsrethinkingpy-60"></a>
<a name="listingsrethinkingpy-61"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">closure</span><span class="p">)</span>
<a name="listingsrethinkingpy-62"></a>        <span class="n">guide</span> <span class="o">=</span> <span class="n">delta_guide</span><span class="o">.</span><span class="n">laplace_approximation</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a name="listingsrethinkingpy-63"></a>
<a name="listingsrethinkingpy-64"></a>        <span class="c1"># get posterior</span>
<a name="listingsrethinkingpy-65"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">):</span>
<a name="listingsrethinkingpy-66"></a>            <span class="n">guide_trace</span> <span class="o">=</span> <span class="n">poutine</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">guide</span><span class="p">)</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a name="listingsrethinkingpy-67"></a>            <span class="n">model_poutine</span> <span class="o">=</span> <span class="n">poutine</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">poutine</span><span class="o">.</span><span class="n">replay</span><span class="p">(</span><span class="n">lifted_model</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="n">guide_trace</span><span class="p">))</span>
<a name="listingsrethinkingpy-68"></a>            <span class="k">yield</span> <span class="n">model_poutine</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="mf">1.0</span>
<a name="listingsrethinkingpy-69"></a>
<a name="listingsrethinkingpy-70"></a>        <span class="n">pyro</span><span class="o">.</span><span class="n">clear_param_store</span><span class="p">()</span>
<a name="listingsrethinkingpy-71"></a>
<a name="listingsrethinkingpy-72"></a>
<a name="listingsrethinkingpy-73"></a><span class="k">class</span> <span class="nc">LM</span><span class="p">(</span><span class="n">MAP</span><span class="p">):</span>
<a name="listingsrethinkingpy-74"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="p">{}):</span>
<a name="listingsrethinkingpy-75"></a>        <span class="n">y_name</span><span class="p">,</span> <span class="n">predictor_names</span> <span class="o">=</span> <span class="n">formula</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" ~ "</span><span class="p">)</span>
<a name="listingsrethinkingpy-76"></a>        <span class="n">predictor_names</span> <span class="o">=</span> <span class="n">predictor_names</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" + "</span><span class="p">)</span>
<a name="listingsrethinkingpy-77"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="n">y_name</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">y_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)}</span>
<a name="listingsrethinkingpy-78"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="s2">"mean"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="s2">"value"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<a name="listingsrethinkingpy-79"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">predictors</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">predictor_names</span><span class="p">}</span>
<a name="listingsrethinkingpy-80"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_predictor_means</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">predictor</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">predictor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictors</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a name="listingsrethinkingpy-81"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">LM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
<a name="listingsrethinkingpy-82"></a>
<a name="listingsrethinkingpy-83"></a>    <span class="k">def</span> <span class="nf">_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="listingsrethinkingpy-84"></a>        <span class="n">intercept</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">"intercept"</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="s2">"mean"</span><span class="p">],</span> <span class="mi">10</span><span class="p">))</span>
<a name="listingsrethinkingpy-85"></a>        <span class="n">mu</span> <span class="o">=</span> <span class="n">intercept</span>
<a name="listingsrethinkingpy-86"></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">predictor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a name="listingsrethinkingpy-87"></a>            <span class="n">coef</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<a name="listingsrethinkingpy-88"></a>            <span class="c1"># use "centering trick"</span>
<a name="listingsrethinkingpy-89"></a>            <span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">coef</span> <span class="o">*</span> <span class="p">(</span><span class="n">predictor</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predictor_means</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
<a name="listingsrethinkingpy-90"></a>        <span class="n">sigma</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">"sigma"</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">HalfCauchy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a name="listingsrethinkingpy-91"></a>        <span class="k">with</span> <span class="n">pyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">"plate"</span><span class="p">):</span>
<a name="listingsrethinkingpy-92"></a>            <span class="k">return</span> <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="s2">"name"</span><span class="p">],</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="s2">"value"</span><span class="p">])</span>
<a name="listingsrethinkingpy-93"></a>
<a name="listingsrethinkingpy-94"></a>    <span class="k">def</span> <span class="nf">_get_centering_constant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coefs</span><span class="p">):</span>
<a name="listingsrethinkingpy-95"></a>        <span class="n">center</span> <span class="o">=</span> <span class="mi">0</span>
<a name="listingsrethinkingpy-96"></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">predictor_mean</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predictor_means</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a name="listingsrethinkingpy-97"></a>            <span class="n">center</span> <span class="o">=</span> <span class="n">center</span> <span class="o">+</span> <span class="n">coefs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">*</span> <span class="n">predictor_mean</span>
<a name="listingsrethinkingpy-98"></a>        <span class="k">return</span> <span class="n">center</span>
<a name="listingsrethinkingpy-99"></a>
<a name="listingsrethinkingpy-100"></a>
<a name="listingsrethinkingpy-101"></a><span class="k">def</span> <span class="nf">glimmer</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s2">"normal"</span><span class="p">):</span>
<a name="listingsrethinkingpy-102"></a>    <span class="k">print</span><span class="p">(</span><span class="s2">"def model({}):"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
<a name="listingsrethinkingpy-103"></a>    <span class="k">print</span><span class="p">(</span><span class="s2">"    intercept = pyro.sample('intercept', dist.Normal(0, 10))"</span><span class="p">)</span>
<a name="listingsrethinkingpy-104"></a>    <span class="n">mu_str</span> <span class="o">=</span> <span class="s2">"    mu = intercept + "</span>
<a name="listingsrethinkingpy-105"></a>    <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
<a name="listingsrethinkingpy-106"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">latent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
<a name="listingsrethinkingpy-107"></a>        <span class="k">print</span><span class="p">(</span><span class="s2">"    b_{} = pyro.sample('b_{}', dist.Normal(0, 10))"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latent</span><span class="p">,</span> <span class="n">latent</span><span class="p">))</span>
<a name="listingsrethinkingpy-108"></a>        <span class="n">mu_str</span> <span class="o">+=</span> <span class="s2">"b_{} * {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latent</span><span class="p">,</span> <span class="n">latent</span><span class="p">)</span>
<a name="listingsrethinkingpy-109"></a>    <span class="k">print</span><span class="p">(</span><span class="n">mu_str</span><span class="p">)</span>
<a name="listingsrethinkingpy-110"></a>    <span class="k">print</span><span class="p">(</span><span class="s2">"    sigma = pyro.sample('sigma', dist.HalfCauchy(2))"</span><span class="p">)</span>
<a name="listingsrethinkingpy-111"></a>    <span class="k">print</span><span class="p">(</span><span class="s2">"    with pyro.plate('plate'):"</span><span class="p">)</span>
<a name="listingsrethinkingpy-112"></a>    <span class="k">print</span><span class="p">(</span><span class="s2">"        return pyro.sample('{}', dist.Normal(mu, sigma), obs={})"</span>
<a name="listingsrethinkingpy-113"></a>          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
<a name="listingsrethinkingpy-114"></a>
<a name="listingsrethinkingpy-115"></a>
<a name="listingsrethinkingpy-116"></a><span class="k">def</span> <span class="nf">coef</span><span class="p">(</span><span class="n">posterior</span><span class="p">):</span>
<a name="listingsrethinkingpy-117"></a>    <span class="n">mean</span> <span class="o">=</span> <span class="p">{}</span>
<a name="listingsrethinkingpy-118"></a>    <span class="n">node_supports</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">marginal</span><span class="p">(</span><span class="n">posterior</span><span class="o">.</span><span class="n">exec_traces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stochastic_nodes</span><span class="p">)</span><span class="o">.</span><span class="n">support</span><span class="p">()</span>
<a name="listingsrethinkingpy-119"></a>    <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">support</span> <span class="ow">in</span> <span class="n">node_supports</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a name="listingsrethinkingpy-120"></a>        <span class="n">mean</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<a name="listingsrethinkingpy-121"></a>    <span class="c1"># correct `intercept` due to "centering trick"</span>
<a name="listingsrethinkingpy-122"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="n">LM</span><span class="p">):</span>
<a name="listingsrethinkingpy-123"></a>        <span class="n">center</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">_get_centering_constant</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
<a name="listingsrethinkingpy-124"></a>        <span class="n">mean</span><span class="p">[</span><span class="s2">"intercept"</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean</span><span class="p">[</span><span class="s2">"intercept"</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span>
<a name="listingsrethinkingpy-125"></a>    <span class="k">return</span> <span class="n">mean</span>
<a name="listingsrethinkingpy-126"></a>
<a name="listingsrethinkingpy-127"></a>
<a name="listingsrethinkingpy-128"></a><span class="k">def</span> <span class="nf">vcov</span><span class="p">(</span><span class="n">posterior</span><span class="p">):</span>
<a name="listingsrethinkingpy-129"></a>    <span class="n">node_supports</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">marginal</span><span class="p">(</span><span class="n">posterior</span><span class="o">.</span><span class="n">exec_traces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stochastic_nodes</span><span class="p">)</span><span class="o">.</span><span class="n">support</span><span class="p">()</span>
<a name="listingsrethinkingpy-130"></a>    <span class="n">packed_support</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">support</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="listingsrethinkingpy-131"></a>                                <span class="k">for</span> <span class="n">support</span> <span class="ow">in</span> <span class="n">node_supports</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a name="listingsrethinkingpy-132"></a>    <span class="n">cov_scheme</span> <span class="o">=</span> <span class="n">WelfordCovariance</span><span class="p">(</span><span class="n">diagonal</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<a name="listingsrethinkingpy-133"></a>    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">packed_support</span><span class="p">:</span>
<a name="listingsrethinkingpy-134"></a>        <span class="n">cov_scheme</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
<a name="listingsrethinkingpy-135"></a>    <span class="k">return</span> <span class="n">cov_scheme</span><span class="o">.</span><span class="n">get_covariance</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<a name="listingsrethinkingpy-136"></a>
<a name="listingsrethinkingpy-137"></a>
<a name="listingsrethinkingpy-138"></a><span class="k">def</span> <span class="nf">precis</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<a name="listingsrethinkingpy-139"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="n">TracePosterior</span><span class="p">):</span>
<a name="listingsrethinkingpy-140"></a>        <span class="n">node_supports</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">marginal</span><span class="p">(</span><span class="n">posterior</span><span class="o">.</span><span class="n">exec_traces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stochastic_nodes</span><span class="p">)</span><span class="o">.</span><span class="n">support</span><span class="p">()</span>
<a name="listingsrethinkingpy-141"></a>    <span class="k">else</span><span class="p">:</span>
<a name="listingsrethinkingpy-142"></a>        <span class="n">node_supports</span> <span class="o">=</span> <span class="n">posterior</span>
<a name="listingsrethinkingpy-143"></a>    <span class="n">mean</span><span class="p">,</span> <span class="n">std_dev</span><span class="p">,</span> <span class="n">lower_hpd</span><span class="p">,</span> <span class="n">upper_hpd</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
<a name="listingsrethinkingpy-144"></a>    <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">support</span> <span class="ow">in</span> <span class="n">node_supports</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a name="listingsrethinkingpy-145"></a>        <span class="n">mean</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a name="listingsrethinkingpy-146"></a>        <span class="n">std_dev</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a name="listingsrethinkingpy-147"></a>        <span class="n">hpdi</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span><span class="n">support</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
<a name="listingsrethinkingpy-148"></a>        <span class="n">lower_hpd</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">hpdi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a name="listingsrethinkingpy-149"></a>        <span class="n">upper_hpd</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">hpdi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a name="listingsrethinkingpy-150"></a>    <span class="c1"># correct `intercept` due to "centering trick"</span>
<a name="listingsrethinkingpy-151"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="n">LM</span><span class="p">):</span>
<a name="listingsrethinkingpy-152"></a>        <span class="n">center</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">_get_centering_constant</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
<a name="listingsrethinkingpy-153"></a>        <span class="n">mean</span><span class="p">[</span><span class="s2">"intercept"</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean</span><span class="p">[</span><span class="s2">"intercept"</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span>
<a name="listingsrethinkingpy-154"></a>        <span class="n">lower_hpd</span><span class="p">[</span><span class="s2">"intercept"</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower_hpd</span><span class="p">[</span><span class="s2">"intercept"</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span>
<a name="listingsrethinkingpy-155"></a>        <span class="n">upper_hpd</span><span class="p">[</span><span class="s2">"intercept"</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_hpd</span><span class="p">[</span><span class="s2">"intercept"</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span>
<a name="listingsrethinkingpy-156"></a>    <span class="n">precis</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s2">"Mean"</span><span class="p">:</span> <span class="n">mean</span><span class="p">,</span> <span class="s2">"StdDev"</span><span class="p">:</span> <span class="n">std_dev</span><span class="p">,</span> <span class="s2">"|0.89"</span><span class="p">:</span> <span class="n">lower_hpd</span><span class="p">,</span> <span class="s2">"0.89|"</span><span class="p">:</span> <span class="n">upper_hpd</span><span class="p">})</span>
<a name="listingsrethinkingpy-157"></a>
<a name="listingsrethinkingpy-158"></a>    <span class="k">if</span> <span class="n">corr</span><span class="p">:</span>
<a name="listingsrethinkingpy-159"></a>        <span class="n">cov</span> <span class="o">=</span> <span class="n">vcov</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span>
<a name="listingsrethinkingpy-160"></a>        <span class="n">corr</span> <span class="o">=</span> <span class="n">cov</span> <span class="o">/</span> <span class="n">cov</span><span class="o">.</span><span class="n">diag</span><span class="p">()</span><span class="o">.</span><span class="n">ger</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">diag</span><span class="p">())</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
<a name="listingsrethinkingpy-161"></a>        <span class="n">corr_dict</span> <span class="o">=</span> <span class="p">{}</span>
<a name="listingsrethinkingpy-162"></a>        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
<a name="listingsrethinkingpy-163"></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">posterior</span><span class="o">.</span><span class="n">exec_traces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stochastic_nodes</span><span class="p">:</span>
<a name="listingsrethinkingpy-164"></a>            <span class="n">corr_dict</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[:,</span> <span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a name="listingsrethinkingpy-165"></a>            <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span>
<a name="listingsrethinkingpy-166"></a>        <span class="n">precis</span> <span class="o">=</span> <span class="n">precis</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="n">corr_dict</span><span class="p">)</span>
<a name="listingsrethinkingpy-167"></a>    <span class="k">return</span> <span class="n">precis</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span>
<a name="listingsrethinkingpy-168"></a>
<a name="listingsrethinkingpy-169"></a>
<a name="listingsrethinkingpy-170"></a><span class="k">def</span> <span class="nf">link</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<a name="listingsrethinkingpy-171"></a>    <span class="n">obs_node</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">exec_traces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">observation_nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a name="listingsrethinkingpy-172"></a>    <span class="n">mu</span> <span class="o">=</span> <span class="p">[]</span>
<a name="listingsrethinkingpy-173"></a>    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
<a name="listingsrethinkingpy-174"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<a name="listingsrethinkingpy-175"></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">_categorical</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a name="listingsrethinkingpy-176"></a>            <span class="n">trace</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">exec_traces</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<a name="listingsrethinkingpy-177"></a>            <span class="n">mu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">obs_node</span><span class="p">][</span><span class="s2">"fn"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
<a name="listingsrethinkingpy-178"></a>    <span class="k">else</span><span class="p">:</span>
<a name="listingsrethinkingpy-179"></a>        <span class="n">data</span><span class="p">[</span><span class="n">obs_node</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<a name="listingsrethinkingpy-180"></a>        <span class="n">predictive</span> <span class="o">=</span> <span class="n">TracePredictive</span><span class="p">(</span><span class="n">poutine</span><span class="o">.</span><span class="n">lift</span><span class="p">(</span><span class="n">posterior</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">None</span><span class="p">),</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
<a name="listingsrethinkingpy-181"></a>        <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">predictive</span><span class="o">.</span><span class="n">exec_traces</span><span class="p">:</span>
<a name="listingsrethinkingpy-182"></a>            <span class="n">mu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">obs_node</span><span class="p">][</span><span class="s2">"fn"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
<a name="listingsrethinkingpy-183"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<a name="listingsrethinkingpy-184"></a>
<a name="listingsrethinkingpy-185"></a>
<a name="listingsrethinkingpy-186"></a><span class="k">def</span> <span class="nf">sim</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<a name="listingsrethinkingpy-187"></a>    <span class="n">obs_node</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">exec_traces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">observation_nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a name="listingsrethinkingpy-188"></a>    <span class="n">obs</span> <span class="o">=</span> <span class="p">[]</span>
<a name="listingsrethinkingpy-189"></a>    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
<a name="listingsrethinkingpy-190"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<a name="listingsrethinkingpy-191"></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">_categorical</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a name="listingsrethinkingpy-192"></a>            <span class="n">trace</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">exec_traces</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<a name="listingsrethinkingpy-193"></a>            <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">obs_node</span><span class="p">][</span><span class="s2">"fn"</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">())</span>
<a name="listingsrethinkingpy-194"></a>    <span class="k">else</span><span class="p">:</span>
<a name="listingsrethinkingpy-195"></a>        <span class="n">data</span><span class="p">[</span><span class="n">obs_node</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<a name="listingsrethinkingpy-196"></a>        <span class="n">predictive</span> <span class="o">=</span> <span class="n">TracePredictive</span><span class="p">(</span><span class="n">poutine</span><span class="o">.</span><span class="n">lift</span><span class="p">(</span><span class="n">posterior</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">None</span><span class="p">),</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
<a name="listingsrethinkingpy-197"></a>        <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">predictive</span><span class="o">.</span><span class="n">exec_traces</span><span class="p">:</span>
<a name="listingsrethinkingpy-198"></a>            <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">obs_node</span><span class="p">][</span><span class="s2">"value"</span><span class="p">])</span>
<a name="listingsrethinkingpy-199"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<a name="listingsrethinkingpy-200"></a>
<a name="listingsrethinkingpy-201"></a>
<a name="listingsrethinkingpy-202"></a><span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="o">*</span><span class="n">posteriors</span><span class="p">):</span>
<a name="listingsrethinkingpy-203"></a>    <span class="n">WAIC_dict</span><span class="p">,</span> <span class="n">WAIC_vec</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
<a name="listingsrethinkingpy-204"></a>    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
<a name="listingsrethinkingpy-205"></a>        <span class="n">WAIC</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">WAIC</span><span class="p">(</span><span class="n">pointwise</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<a name="listingsrethinkingpy-206"></a>        <span class="n">WAIC_vec</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAIC</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"WAIC_vec"</span><span class="p">)</span>
<a name="listingsrethinkingpy-207"></a>        <span class="n">WAIC_dict</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">w_name</span><span class="p">:</span> <span class="n">w</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">w_name</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">WAIC</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a name="listingsrethinkingpy-208"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">WAIC_dict</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"WAIC"</span><span class="p">)</span>
<a name="listingsrethinkingpy-209"></a>    <span class="n">df</span><span class="p">[</span><span class="s2">"dWAIC"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"WAIC"</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">"WAIC"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a name="listingsrethinkingpy-210"></a>    <span class="n">weight</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">"dWAIC"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">))</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
<a name="listingsrethinkingpy-211"></a>    <span class="n">df</span><span class="p">[</span><span class="s2">"weight"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">weight</span> <span class="o">/</span> <span class="n">weight</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a name="listingsrethinkingpy-212"></a>    <span class="n">dSE</span> <span class="o">=</span> <span class="p">[]</span>
<a name="listingsrethinkingpy-213"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
<a name="listingsrethinkingpy-214"></a>        <span class="n">WAIC1</span> <span class="o">=</span> <span class="n">WAIC_vec</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
<a name="listingsrethinkingpy-215"></a>        <span class="n">WAIC2</span> <span class="o">=</span> <span class="n">WAIC_vec</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
<a name="listingsrethinkingpy-216"></a>        <span class="n">dSE</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">WAIC1</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">WAIC2</span> <span class="o">-</span> <span class="n">WAIC1</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">())</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<a name="listingsrethinkingpy-217"></a>    <span class="n">df</span><span class="p">[</span><span class="s2">"dSE"</span><span class="p">]</span> <span class="o">=</span> <span class="n">dSE</span>
<a name="listingsrethinkingpy-218"></a>    <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">"se"</span><span class="p">:</span> <span class="s2">"SE"</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<a name="listingsrethinkingpy-219"></a>    <span class="k">return</span> <span class="n">df</span><span class="p">[[</span><span class="s2">"WAIC"</span><span class="p">,</span> <span class="s2">"pWAIC"</span><span class="p">,</span> <span class="s2">"dWAIC"</span><span class="p">,</span> <span class="s2">"weight"</span><span class="p">,</span> <span class="s2">"SE"</span><span class="p">,</span> <span class="s2">"dSE"</span><span class="p">]]</span>
<a name="listingsrethinkingpy-220"></a>
<a name="listingsrethinkingpy-221"></a>
<a name="listingsrethinkingpy-222"></a><span class="k">def</span> <span class="nf">compare_plot</span><span class="p">(</span><span class="n">waic_df</span><span class="p">):</span>
<a name="listingsrethinkingpy-223"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">waic_df</span><span class="p">[</span><span class="s2">"WAIC"</span><span class="p">],</span> <span class="n">waic_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">"ko"</span><span class="p">,</span> <span class="n">fillstyle</span><span class="o">=</span><span class="s2">"none"</span><span class="p">)</span>
<a name="listingsrethinkingpy-224"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">waic_df</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
<a name="listingsrethinkingpy-225"></a>        <span class="n">se_df</span> <span class="o">=</span> <span class="n">waic_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model</span><span class="p">,</span> <span class="p">:]</span>
<a name="listingsrethinkingpy-226"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">se_df</span><span class="p">[</span><span class="s2">"WAIC"</span><span class="p">]</span> <span class="o">-</span> <span class="n">se_df</span><span class="p">[</span><span class="s2">"SE"</span><span class="p">],</span> <span class="n">se_df</span><span class="p">[</span><span class="s2">"WAIC"</span><span class="p">]</span> <span class="o">+</span> <span class="n">se_df</span><span class="p">[</span><span class="s2">"SE"</span><span class="p">]],</span> <span class="p">[</span><span class="n">model</span><span class="p">,</span> <span class="n">model</span><span class="p">],</span>
<a name="listingsrethinkingpy-227"></a>                 <span class="n">c</span><span class="o">=</span><span class="s2">"k"</span><span class="p">)</span>
<a name="listingsrethinkingpy-228"></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a name="listingsrethinkingpy-229"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">se_df</span><span class="p">[</span><span class="s2">"WAIC"</span><span class="p">]</span> <span class="o">-</span> <span class="n">se_df</span><span class="p">[</span><span class="s2">"dSE"</span><span class="p">],</span> <span class="n">se_df</span><span class="p">[</span><span class="s2">"WAIC"</span><span class="p">]</span> <span class="o">+</span> <span class="n">se_df</span><span class="p">[</span><span class="s2">"dSE"</span><span class="p">]],</span>
<a name="listingsrethinkingpy-230"></a>                     <span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>
<a name="listingsrethinkingpy-231"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">waic_df</span><span class="p">[</span><span class="s2">"WAIC"</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">waic_df</span><span class="p">[</span><span class="s2">"pWAIC"</span><span class="p">],</span> <span class="n">waic_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">"ko"</span><span class="p">)</span>
<a name="listingsrethinkingpy-232"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">waic_df</span><span class="p">[</span><span class="s2">"WAIC"</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">waic_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)],</span> <span class="s2">"^"</span><span class="p">,</span>
<a name="listingsrethinkingpy-233"></a>             <span class="n">c</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span> <span class="n">fillstyle</span><span class="o">=</span><span class="s2">"none"</span><span class="p">)</span>
<a name="listingsrethinkingpy-234"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<a name="listingsrethinkingpy-235"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">waic_df</span><span class="p">[</span><span class="s2">"WAIC"</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">"k"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<a name="listingsrethinkingpy-236"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">)</span>
<a name="listingsrethinkingpy-237"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"deviance"</span><span class="p">)</span>
<a name="listingsrethinkingpy-238"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"WAIC"</span><span class="p">)</span>
<a name="listingsrethinkingpy-239"></a>
<a name="listingsrethinkingpy-240"></a>
<a name="listingsrethinkingpy-241"></a><span class="k">def</span> <span class="nf">coeftab</span><span class="p">(</span><span class="o">*</span><span class="n">models</span><span class="p">,</span> <span class="n">PI</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
<a name="listingsrethinkingpy-242"></a>    <span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="n">precis</span><span class="p">()</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<a name="listingsrethinkingpy-243"></a>    <span class="n">coef_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
<a name="listingsrethinkingpy-244"></a>    <span class="n">mean_df</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s2">"Mean"</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a name="listingsrethinkingpy-245"></a>    <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
<a name="listingsrethinkingpy-246"></a>    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
<a name="listingsrethinkingpy-247"></a>        <span class="n">keys</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_latent_shapes</span><span class="p">)</span>
<a name="listingsrethinkingpy-248"></a>    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">keys</span><span class="p">))</span>
<a name="listingsrethinkingpy-249"></a>    <span class="n">mean_df</span> <span class="o">=</span> <span class="n">mean_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keys</span><span class="p">,</span> <span class="p">:]</span>
<a name="listingsrethinkingpy-250"></a>    <span class="n">mean_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"nobs"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">sim</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
<a name="listingsrethinkingpy-251"></a>    <span class="k">if</span> <span class="n">PI</span><span class="p">:</span>
<a name="listingsrethinkingpy-252"></a>        <span class="n">lower_PI</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s2">"5.5%"</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keys</span><span class="p">,</span> <span class="p">:]</span>
<a name="listingsrethinkingpy-253"></a>        <span class="n">upper_PI</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s2">"94.5%"</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keys</span><span class="p">,</span> <span class="p">:]</span>
<a name="listingsrethinkingpy-254"></a>        <span class="k">return</span> <span class="n">mean_df</span><span class="p">,</span> <span class="n">lower_PI</span><span class="p">,</span> <span class="n">upper_PI</span>
<a name="listingsrethinkingpy-255"></a>    <span class="k">return</span> <span class="n">mean_df</span>
<a name="listingsrethinkingpy-256"></a>
<a name="listingsrethinkingpy-257"></a>
<a name="listingsrethinkingpy-258"></a><span class="k">def</span> <span class="nf">ensemble</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">models</span><span class="p">):</span>
<a name="listingsrethinkingpy-259"></a>    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e3</span><span class="p">)</span>
<a name="listingsrethinkingpy-260"></a>    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<a name="listingsrethinkingpy-261"></a>    <span class="n">WAIC_df</span> <span class="o">=</span> <span class="n">compare</span><span class="p">(</span><span class="o">*</span><span class="n">models</span><span class="p">)</span>
<a name="listingsrethinkingpy-262"></a>    <span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">WAIC_df</span><span class="p">[</span><span class="s2">"weight"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
<a name="listingsrethinkingpy-263"></a>    <span class="n">models_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">}</span>
<a name="listingsrethinkingpy-264"></a>    <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">models_dict</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">WAIC_df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<a name="listingsrethinkingpy-265"></a>    <span class="n">sims</span> <span class="o">=</span> <span class="p">[</span><span class="n">models_dict</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">sim</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">WAIC_df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<a name="listingsrethinkingpy-266"></a>    <span class="n">index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span>
<a name="listingsrethinkingpy-267"></a>                       <span class="p">(</span><span class="n">weight</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">long</span><span class="p">()</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="n">n</span><span class="p">)])</span>
<a name="listingsrethinkingpy-268"></a>    <span class="n">weighted_link</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">index</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">links</span><span class="p">)])</span>
<a name="listingsrethinkingpy-269"></a>    <span class="n">weighted_sim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">index</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sims</span><span class="p">)])</span>
<a name="listingsrethinkingpy-270"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">"link"</span><span class="p">:</span> <span class="n">weighted_link</span><span class="p">,</span> <span class="s2">"sim"</span><span class="p">:</span> <span class="n">weighted_sim</span><span class="p">}</span>
<a name="listingsrethinkingpy-271"></a>
<a name="listingsrethinkingpy-272"></a>
<a name="listingsrethinkingpy-273"></a><span class="k">def</span> <span class="nf">chainmode</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">adj</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<a name="listingsrethinkingpy-274"></a>    <span class="n">bw_factor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.75</span> <span class="o">*</span> <span class="n">samples</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.2</span><span class="p">)</span>
<a name="listingsrethinkingpy-275"></a>    <span class="n">bw</span> <span class="o">=</span> <span class="n">adj</span> <span class="o">*</span> <span class="n">bw_factor</span> <span class="o">*</span> <span class="n">samples</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<a name="listingsrethinkingpy-276"></a>    <span class="n">x_min</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<a name="listingsrethinkingpy-277"></a>    <span class="n">x_max</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<a name="listingsrethinkingpy-278"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<a name="listingsrethinkingpy-279"></a>    <span class="n">y</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">bw</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">logsumexp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
<a name="listingsrethinkingpy-280"></a>    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">y</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">))</span>
<a name="listingsrethinkingpy-281"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">plot</span><span class="p">:</span>
<a name="listingsrethinkingpy-282"></a>        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
<a name="listingsrethinkingpy-283"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
<a name="listingsrethinkingpy-284"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlab</span><span class="p">)</span>
<a name="listingsrethinkingpy-285"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Density"</span><span class="p">)</span>
</pre></td>
</tr></table>
<!--End of body content--><footer id="footer"><div class="text-center">
  Contents © 2019         <a href="mailto:fehiepsi@gmail.com">Du Phan</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
  <img alt="Creative Commons License BY-NC-SA" style="border-width:0; margin-bottom:12px;" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"></a>

</div>

            
        </footer>
</div>
</div>


        <script src="../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-131299125-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-131299125-1');
</script>
</body>
</html>
